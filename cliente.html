<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5">
    <title>Men√∫ del Bar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <style>

:root {
    --primary: #4f46e5;
    --primary-dark: #4338ca;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-700: #374151;
    --danger: #ef4444;
}

        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
.product-card {
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    will-change: transform;
}

.product-card:hover {
    transform: scale(1.05);
}

.product-card:active {
    transform: scale(1.03);
}        @media print {
            body * { visibility: hidden; }
            #vista-ticket, #vista-ticket * { visibility: visible; }
            #vista-ticket { position: absolute; left: 0; top: 0; width: 100%; background: white; }
            button { display: none !important; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        .category-btn.active { background-color: #4f46e5; color: white; }

        /* ‚úÖ IM√ÅGENES EN CUADRADO - Se ven completas sin recortar */
.producto-img-cuadrada {
    width: 100%;
    height: 100px;              /* M√≥vil: 100px */
    object-fit: contain;
    background-color: #f9fafb;
    padding: 4px;
    box-sizing: border-box;
}

@media (min-width: 768px) {
    .producto-img-cuadrada {
        height: 150px;          /* Desktop: 150px */
    }
}

/* Animaci√≥n al a√±adir producto */
@keyframes addToCart {
    0% { transform: scale(1); }
    50% { transform: scale(0.95); }
    100% { transform: scale(1); }
}

@keyframes cartBump {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
}

.product-card.adding {
    animation: addToCart 0.3s ease;
}

.cart-bump {
    animation: cartBump 0.3s ease;
}

/* Contador de cantidad en producto */
.product-quantity {
    display: none;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.product-quantity.active {
    display: flex;
}

.qty-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    font-size: 1.25rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qty-btn.minus {
    background: var(--gray-200);
    color: var(--gray-700);
}

.qty-btn.minus:hover {
    background: var(--gray-300);
}

.qty-btn.plus {
    background: var(--primary);
    color: white;
}

.qty-btn.plus:hover {
    background: var(--primary-dark);
}

.qty-value {
    font-size: 1.125rem;
    font-weight: 700;
    min-width: 32px;
    text-align: center;
}

/* Badge de cantidad en carrito */
.cart-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--danger);
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 20px;
    height: 20px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 6px;
}

    </style>
</head>
<body class="bg-gray-50 pb-24">

    <!-- Header -->
    <header class="bg-indigo-600 text-white p-4 shadow sticky top-0 z-10">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold">üçπ Men√∫ Digital</h1>
                <p class="text-xs text-indigo-200">Pide desde tu mesa</p>
            </div>
            <div id="mesa-badge" class="bg-white text-indigo-600 px-3 py-1 rounded-full text-sm font-bold hidden">
                Mesa <span id="mesa-number">-</span>
            </div>
        </div>
    </header>

    <!-- Selector de Mesa -->
    <div class="p-4 bg-white shadow-sm mb-4">
        <label class="block text-gray-700 text-sm font-bold mb-2">ü™ë ¬øEn qu√© mesa est√°s?</label>
        <input type="number" id="mesa-input" class="shadow appearance-none border rounded w-full py-3 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:border-indigo-500 text-lg" placeholder="Ej: 4">
        <p class="text-xs text-gray-500 mt-1">‚ÑπÔ∏è Si escaneaste el QR de tu mesa, este campo ya est√° rellenado</p>
    </div>

    <!-- Filtros de Categor√≠as -->
    <div class="px-4 mb-4 overflow-x-auto">
        <div class="flex gap-2" id="contenedor-categorias">
            <button onclick="filtrarPorCategoria('todos')" class="category-btn active px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium whitespace-nowrap">üìã Todos</button>
        </div>
    </div>

    <!-- Lista de Productos -->
    <div class="px-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="contenedor-productos">
        <div class="col-span-2 text-center text-gray-500 mt-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
            <p class="mt-2">Cargando men√∫...</p>
        </div>
    </div>

    <!-- Bot√≥n Flotante Carrito -->
    <div class="fixed bottom-0 w-full bg-white border-t p-4 shadow-lg flex justify-between items-center z-20">
        <div>
            <p class="text-sm text-gray-500">Total a pagar</p>
            <p class="text-xl font-bold text-indigo-600" id="total-display">0.00‚Ç¨</p>
        </div>
        <button onclick="abrirModalPago()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow transition transform active:scale-95">
            üõí Ver Carrito (<span id="contador-carrito">0</span>)
        </button>
    </div>

    <!-- Modal de Carrito (EDITABLE) -->
    <div id="modal-carrito" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">üõí Tu Carrito</h2>
            
            <!-- Lista de Productos en Carrito -->
            <div id="lista-carrito" class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                <!-- Se llena con JS -->
            </div>
            
            <!-- Total -->
            <div class="flex justify-between font-bold text-lg mb-4 pt-4 border-t">
                <span>Total:</span>
                <span id="modal-total" class="text-indigo-600">0.00‚Ç¨</span>
            </div>

            <!-- Botones de Acci√≥n -->
            <div class="flex gap-2">
                <button onclick="cerrarModalCarrito()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-400 transition">
                    Seguir Pidiendo
                </button>
                <button onclick="irAPagar()" class="flex-1 bg-green-500 text-white py-3 rounded-lg font-bold hover:bg-green-600 transition">
                    Ir a Pagar üí≥
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Pago -->
<div id="modal-pago" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto animate-fade-in">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">üí≥ Opciones de Pago</h2>
            <!-- ‚úÖ NUEVO: Bot√≥n Vaciar Carrito en modal de pago -->
            <button onclick="vaciarCarritoDesdePago()" class="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-1 px-3 py-1 rounded hover:bg-red-50 transition">
                üóëÔ∏è Vaciar
            </button>
        </div>
        
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <h3 class="font-bold text-sm mb-2 text-gray-700">üìã Tu pedido:</h3>
            <ul id="lista-resumen" class="text-sm text-gray-600 max-h-32 overflow-y-auto space-y-1"></ul>
            <div class="flex justify-between font-bold text-lg mt-3 pt-3 border-t border-gray-300">
                <span>Total:</span>
                <span id="modal-total-pago" class="text-indigo-600">0.00‚Ç¨</span>
            </div>
        </div>

            <!-- OPCI√ìN 1: Pagar Online con Tarjeta -->
            <div class="mb-4">
                <h3 class="font-bold text-sm mb-2 text-gray-700">Opci√≥n 1: Pago Online</h3>
                <div id="payment-element" class="mb-3"></div>
                <div id="payment-message" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded mb-4"></div>
                <button id="submit-button" onclick="procesarPago()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                    üí≥ Pagar con Tarjeta Ahora
                </button>
            </div>

            <!-- Separador -->
            <div class="relative my-4">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">o tambi√©n puedes</span>
                </div>
            </div>

            <!-- OPCI√ìN 2: Pagar en Barra -->
            <div>
                <h3 class="font-bold text-sm mb-2 text-gray-700">Opci√≥n 2: Pagar en Barra</h3>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                    <p class="text-xs text-blue-700">üìç Env√≠a tu pedido ahora y paga cuando pases por la barra.</p>
                </div>
                <button onclick="pedirPagarEnBarra()" class="w-full bg-orange-500 text-white py-3 rounded-lg font-bold hover:bg-orange-600 transition flex items-center justify-center gap-2">
                    üç∫ Pedir y Pagar en Barra
                </button>
            </div>
            
            <button onclick="cerrarModalPago()" class="w-full mt-3 bg-gray-300 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-400 transition">
                Cancelar
            </button>
            
            <p class="text-xs text-gray-400 mt-4 text-center">üîí Pago online procesado de forma segura por Stripe</p>
        </div>
    </div>

    <!-- VISTA DE TICKET -->
    <div id="vista-ticket" class="hidden fixed inset-0 bg-gray-100 z-50 overflow-y-auto">
        <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
            <div class="bg-gray-800 text-white p-6 text-center">
                <img id="ticket-logo" src="images/logobar.jpeg" alt="Logo" class="w-20 h-20 mx-auto rounded-full border-4 border-white mb-3 object-cover bg-white">
                <h1 class="text-2xl font-bold" id="ticket-nombre-bar">MI BAR</h1>
                <p class="text-sm text-gray-300" id="ticket-direccion">Calle Ejemplo, 123 - Madrid</p>
                <p class="text-sm text-gray-300" id="ticket-telefono">Tel: 912 345 678</p>
                <p class="text-sm text-gray-300" id="ticket-cif">CIF: B-12345678</p>
            </div>
            <div class="p-4 border-b border-gray-200">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">Ticket #<span id="ticket-id" class="font-mono">----</span></span>
                    <span id="ticket-fecha" class="text-gray-600">--/--/---- --:--</span>
                </div>
                <div class="flex justify-between text-sm mt-2">
                    <span class="text-gray-600">Mesa: <span id="ticket-mesa" class="font-bold text-gray-800">--</span></span>
                    <span id="ticket-metodo-pago" class="font-medium">Efectivo</span>
                </div>
            </div>
            <div class="p-4 border-b border-gray-200">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-left border-b border-gray-300">
                            <th class="pb-2 text-gray-600 font-medium">Cant.</th>
                            <th class="pb-2 text-gray-600 font-medium">Producto</th>
                            <th class="pb-2 text-right text-gray-600 font-medium">Precio</th>
                        </tr>
                    </thead>
                    <tbody id="ticket-productos" class="text-gray-800"></tbody>
                </table>
            </div>
            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <div class="flex justify-between text-sm mb-2 text-gray-600">
                    <span>Subtotal</span>
                    <span id="ticket-subtotal">0.00‚Ç¨</span>
                </div>
                <div class="flex justify-between text-sm mb-2 text-gray-600">
                    <span>IVA (10%)</span>
                    <span id="ticket-iva">0.00‚Ç¨</span>
                </div>
                <div class="flex justify-between text-xl font-bold mt-3 pt-3 border-t border-gray-300 text-gray-800">
                    <span>TOTAL</span>
                    <span id="ticket-total" class="text-indigo-600">0.00‚Ç¨</span>
                </div>
            </div>
            <div class="p-6 text-center text-sm text-gray-500">
                <p class="font-medium text-gray-700">¬°Gracias por su pedido!</p>
                <p class="mt-2 text-orange-600 font-bold" id="mensaje-pago-barra">üíµ Paga en la barra al finalizar</p>
                <div class="mt-6 flex flex-col gap-3 max-w-xs mx-auto">
                    <button onclick="imprimirTicket()" class="bg-indigo-600 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-indigo-700 transition shadow-lg">üñ®Ô∏è Imprimir Ticket</button>
                    <button onclick="enviarWhatsApp()" class="bg-green-500 text-white px-4 py-3 rounded-lg text-sm font-bold hover:bg-green-600 transition shadow-lg">üì± Enviar por WhatsApp</button>
                    <button onclick="cerrarTicket()" class="bg-gray-300 text-gray-800 px-4 py-3 rounded-lg text-sm font-bold hover:bg-gray-400 transition shadow-lg">‚úì Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // ============================================
        // ‚öôÔ∏è CONFIGURACI√ìN
        // ============================================
        
        const firebaseConfig = {
  apiKey: "AIzaSyDudXV2iI4pMCedId1hnYL6UGyiGo2zYZY",
  authDomain: "project-ee722b60-4359-4845-bcf.firebaseapp.com",
  projectId: "project-ee722b60-4359-4845-bcf",
  storageBucket: "project-ee722b60-4359-4845-bcf.firebasestorage.app",
  messagingSenderId: "622591271457",
  appId: "1:622591271457:web:fc236bf17fce1281f6b960"       
        };

        const STRIPE_PUBLIC_KEY = "pk_test_TU_CLAVE_PUBLICA_DE_STRIPE";

        const CONFIG_BAR = {
            nombre: "MI BAR",
            telefono: "34600123456",
            logo: "images/logobar.jpeg",
            direccion: "Calle Ejemplo, 123 - Madrid",
            telefonoBar: "912 345 678",
            cif: "B-12345678"
        };

        // ============================================
        // üöÄ INICIALIZACI√ìN
        // ============================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const stripe = Stripe(STRIPE_PUBLIC_KEY);

        let elements, paymentElement;
        let carrito = [];
        let productosDB = [];
        let categoriasDB = [];
        let categoriaActual = 'todos';
        let pedidoActualId = null;
        let pedidoActualData = null;

        // ============================================
        // üì± DETECTAR MESA AUTOM√ÅTICA
        // ============================================

        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const mesaParam = urlParams.get('mesa');
            const inputMesa = document.getElementById('mesa-input');
            const mesaBadge = document.getElementById('mesa-badge');
            const mesaNumber = document.getElementById('mesa-number');
            
            if (mesaParam) {
                inputMesa.value = mesaParam;
                inputMesa.readOnly = true;
                inputMesa.classList.add('bg-gray-200', 'cursor-not-allowed');
                mesaNumber.innerText = mesaParam;
                mesaBadge.classList.remove('hidden');
            }
        });

        // ============================================
        // üì¶ CARGAR PRODUCTOS Y CATEGOR√çAS
        // ============================================

        async function cargarProductos() {
            const contenedor = document.getElementById('contenedor-productos');
            const q = query(collection(db, "productos"), orderBy("nombre"));
            
            try {
                const querySnapshot = await getDocs(q);
                productosDB = [];
                categoriasDB = new Set();
                contenedor.innerHTML = '';

                if (querySnapshot.empty) {
                    contenedor.innerHTML = `<div class="col-span-2 text-center text-red-500 py-10"><p class="text-lg">üòï No hay productos disponibles</p></div>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const prod = { id: doc.id, ...doc.data() };
                    productosDB.push(prod);
                    if (prod.categoria) categoriasDB.add(prod.categoria);
                });

                // Cargar botones de categor√≠as
                cargarBotonesCategorias();
                renderizarProductos();

            } catch (error) {
                console.error("Error cargando productos: ", error);
                contenedor.innerHTML = `<div class="col-span-2 text-center text-red-500 py-10"><p class="text-lg">‚ùå Error de conexi√≥n</p></div>`;
            }
        }

        function cargarBotonesCategorias() {
            const contenedor = document.getElementById('contenedor-categorias');
            contenedor.innerHTML = `<button onclick="filtrarPorCategoria('todos')" class="category-btn active px-4 py-2 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium whitespace-nowrap">üìã Todos</button>`;
            
            const iconos = {
                'bebidas': 'üç∫', 'comida': 'üçî', 'pizzas': 'üçï', 
                'hamburguesas': 'üçî', 'postres': 'üç∞', 'cafes': '‚òï', 'otros': 'üì¶'
            };

            categoriasDB.forEach(cat => {
                const icono = iconos[cat.toLowerCase()] || 'üì¶';
                contenedor.innerHTML += `
                    <button onclick="filtrarPorCategoria('${cat}')" 
                            class="category-btn px-4 py-2 bg-gray-100 text-gray-700 rounded-full text-sm font-medium whitespace-nowrap hover:bg-gray-200 transition">
                        ${icono} ${cat.charAt(0).toUpperCase() + cat.slice(1)}
                    </button>
                `;
            });
        }

        window.filtrarPorCategoria = (categoria) => {
            categoriaActual = categoria;
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-100', 'text-gray-700');
            event.target.classList.add('active', 'bg-indigo-600', 'text-white');
            renderizarProductos();
        };

        function renderizarProductos() {
            var contenedor = document.getElementById('contenedor-productos');
            contenedor.innerHTML = '';

            var productosFiltrados = [];
            if (categoriaActual === 'todos') {
                productosFiltrados = productosDB;
            } else {
                for (var i = 0; i < productosDB.length; i++) {
                    if (productosDB[i].categoria === categoriaActual) {
                        productosFiltrados.push(productosDB[i]);
                    }
                }
            }

            if (productosFiltrados.length === 0) {
                contenedor.innerHTML = '<div class="col-span-2 text-center text-gray-500 py-10"><p>No hay productos</p></div>';
                return;
            }

            for (var i = 0; i < productosFiltrados.length; i++) {
                var prod = productosFiltrados[i];
                // ‚úÖ IMAGEN EN CUADRADO CON object-fit: contain
// Verificar si el producto ya est√° en el carrito
var enCarrito = carrito.find(function(item) { return item.id === prod.id; });
var cantidadEnCarrito = enCarrito ? enCarrito.cantidad : 0;

contenedor.innerHTML += `
    <div class="product-card bg-white rounded-xl shadow overflow-hidden flex flex-col" id="product-${prod.id}">
        <img src="${prod.imagen || 'https://via.placeholder.com/150?text=Producto'}" 
             class="producto-img-cuadrada" 
             alt="${prod.nombre}"
             onerror="this.src='https://via.placeholder.com/150?text=Sin+Imagen'">
        <div class="p-3 flex-1 flex flex-col justify-between">
            <div>
                <h3 class="font-bold text-gray-800 text-sm line-clamp-2">${prod.nombre}</h3>
                <p class="text-xs text-gray-500 mt-1">${prod.categoria || 'General'}</p>
                <p class="text-indigo-600 font-bold mt-1">${parseFloat(prod.precio).toFixed(2)}‚Ç¨</p>
            </div>
            <div class="mt-2">
                <button onclick="window.agregarAlCarrito('${prod.id}')" 
                        class="w-full bg-indigo-100 text-indigo-700 py-2 rounded-lg font-bold text-sm active:bg-indigo-200 transition btn-add-cart"
                        id="btn-add-${prod.id}">
                    + A√±adir al Carrito
                </button>
                <div class="product-quantity ${cantidadEnCarrito > 0 ? 'active' : ''}" id="qty-container-${prod.id}">
                    <button onclick="window.restarCantidad('${prod.id}')" class="qty-btn minus">‚àí</button>
                    <span class="qty-value" id="qty-value-${prod.id}">${cantidadEnCarrito}</span>
                    <button onclick="window.sumarCantidad('${prod.id}')" class="qty-btn plus">+</button>
                </div>
            </div>
    </div>
    </div>
    `;
            }
        }
        cargarProductos();

        // ============================================
        // üõí FUNCIONES DEL CARRITO (EDITABLE)
        // ============================================

window.agregarAlCarrito = function(id) {
    var prod = productosDB.find(function(p) { return p.id === id; });
    if (!prod) return;
    
    var existe = carrito.find(function(item) { return item.id === id; });
    if (existe) {
        existe.cantidad = (existe.cantidad || 1) + 1;
    } else {
        carrito.push({ 
            id: prod.id,
            nombre: prod.nombre, 
            precio: prod.precio, 
            imagen: prod.imagen,
            categoria: prod.categoria,
            cantidad: 1 
        });
    }
    
    // Animaci√≥n en la tarjeta del producto
    var productCard = document.getElementById('product-' + id);
    if (productCard) {
        productCard.classList.add('adding');
        setTimeout(function() { productCard.classList.remove('adding'); }, 300);
    }
    
    // Animaci√≥n en el bot√≥n del carrito
    var carritoBtn = document.querySelector('button[onclick="abrirModalPago()"]');
    if (carritoBtn) {
        carritoBtn.classList.add('cart-bump');
        setTimeout(function() { carritoBtn.classList.remove('cart-bump'); }, 300);
    }
    
    actualizarTotales();
    actualizarControlesProducto(id);
    
    if (navigator.vibrate) navigator.vibrate(50);
};

        window.restarDelCarrito = (id) => {
            const index = carrito.findIndex(item => item.id === id);
            if (index !== -1) {
                if (carrito[index].cantidad > 1) {
                    carrito[index].cantidad--;
                } else {
                    carrito.splice(index, 1);
                }
                actualizarTotales();
                renderizarCarrito();
            }
        };

        window.eliminarDelCarrito = (id) => {
            carrito = carrito.filter(item => item.id !== id);
            actualizarTotales();
            renderizarCarrito();
        };

function actualizarTotales() {
    var total = carrito.reduce(function(sum, item) { 
        return sum + (parseFloat(item.precio) * (item.cantidad || 1)); 
    }, 0);
    
    var cantidad = carrito.reduce(function(sum, item) { 
        return sum + (item.cantidad || 1); 
    }, 0);
    
    document.getElementById('total-display').innerText = total.toFixed(2) + '‚Ç¨';
    document.getElementById('contador-carrito').innerText = cantidad;
    
    // Actualizar todos los controles de producto
    for (var i = 0; i < productosDB.length; i++) {
        actualizarControlesProducto(productosDB[i].id);
    }
}

// Funci√≥n para mostrar/actualizar controles de cantidad en producto
function actualizarControlesProducto(productId) {
    var itemEnCarrito = carrito.find(function(item) { return item.id === productId; });
    var cantidad = itemEnCarrito ? itemEnCarrito.cantidad : 0;
    
    var btnAdd = document.getElementById('btn-add-' + productId);
    var qtyContainer = document.getElementById('qty-container-' + productId);
    var qtyValue = document.getElementById('qty-value-' + productId);
    
    if (cantidad > 0) {
        if (btnAdd) btnAdd.style.display = 'none';
        if (qtyContainer) qtyContainer.classList.add('active');
        if (qtyValue) qtyValue.innerText = cantidad;
    } else {
        if (btnAdd) btnAdd.style.display = 'block';
        if (qtyContainer) qtyContainer.classList.remove('active');
    }
}

// Sumar cantidad desde el producto
window.sumarCantidad = function(productId) {
    var prod = productosDB.find(function(p) { return p.id === productId; });
    if (!prod) return;
    
    var itemEnCarrito = carrito.find(function(item) { return item.id === productId; });
    
    if (itemEnCarrito) {
        itemEnCarrito.cantidad++;
    } else {
        carrito.push({ 
            id: prod.id,
            nombre: prod.nombre, 
            precio: prod.precio, 
            imagen: prod.imagen,
            categoria: prod.categoria,
            cantidad: 1 
        });
    }
    
    // Animaci√≥n
    var productCard = document.getElementById('product-' + productId);
    if (productCard) {
        productCard.classList.add('adding');
        setTimeout(function() { productCard.classList.remove('adding'); }, 300);
    }
    
    // Animaci√≥n del carrito
    var carritoBtn = document.querySelector('button[onclick="abrirModalPago()"]');
    if (carritoBtn) {
        carritoBtn.classList.add('cart-bump');
        setTimeout(function() { carritoBtn.classList.remove('cart-bump'); }, 300);
    }
    
    actualizarTotales();
    actualizarControlesProducto(productId);
    
    if (navigator.vibrate) navigator.vibrate(50);
};

// Restar cantidad desde el producto
window.restarCantidad = function(productId) {
    var index = carrito.findIndex(function(item) { return item.id === productId; });
    if (index === -1) return;
    
    if (carrito[index].cantidad > 1) {
        carrito[index].cantidad--;
    } else {
        carrito.splice(index, 1);
    }
    
    actualizarTotales();
    actualizarControlesProducto(productId);
    renderizarCarrito();
    
    if (navigator.vibrate) navigator.vibrate(30);
};

        function renderizarCarrito() {
            const lista = document.getElementById('lista-carrito');
            lista.innerHTML = '';

            if (carrito.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-500 py-4">Carrito vac√≠o</p>';
                return;
            }

carrito.forEach(function(item) {
    var cantidad = item.cantidad || 1;
    lista.innerHTML += `
        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
            <div class="flex-1">
                <p class="font-bold text-gray-800">${item.nombre}</p>
                <p class="text-sm text-gray-500">${parseFloat(item.precio).toFixed(2)}‚Ç¨ / ud</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="window.restarDelCarrito('${item.id}')" 
                        class="w-8 h-8 bg-gray-200 rounded-full font-bold text-gray-700 hover:bg-gray-300 transition">‚àí</button>
                <span class="w-8 text-center font-bold">${cantidad}</span>
                <button onclick="window.agregarAlCarrito('${item.id}')" 
                        class="w-8 h-8 bg-indigo-100 rounded-full font-bold text-indigo-700 hover:bg-indigo-200 transition">+</button>
                <button onclick="window.eliminarDelCarrito('${item.id}')" 
                        class="ml-2 text-red-500 hover:bg-red-100 p-2 rounded transition" title="Eliminar">üóëÔ∏è</button>
            </div>
        </div>
    `;
});

const total = carrito.reduce((sum, item) => 
    sum + (parseFloat(item.precio) * item.cantidad), 0);

// üîπ IVA incluido dentro del precio
const base = total / 1.10;
const iva = total - base;

document.getElementById('modal-total').innerHTML = `
    <div class="text-sm text-gray-600 flex justify-between">
        <span>Base imponible:</span>
        <span>${base.toFixed(2)}‚Ç¨</span>
    </div>
    <div class="text-sm text-gray-600 flex justify-between">
        <span>IVA incluido (10%):</span>
        <span>${iva.toFixed(2)}‚Ç¨</span>
    </div>
    <div class="flex justify-between font-bold text-lg text-indigo-600 mt-2 border-t pt-2">
        <span>Total:</span>
        <span>${total.toFixed(2)}‚Ç¨</span>
    </div>
`;
        }

        window.cerrarModalCarrito = () => {
            document.getElementById('modal-carrito').classList.add('hidden');
        };

        window.irAPagar = () => {
            cerrarModalCarrito();
            abrirModalPago();
        };

        // ============================================
        // üí≥ MODAL DE PAGO
        // ============================================

// ‚úÖ Nueva funci√≥n para vaciar desde el modal de pago
window.vaciarCarritoDesdePago = () => {
    if (carrito.length === 0) {
        alert("üõí El carrito ya est√° vac√≠o");
        return;
    }
    if (confirm("¬øEst√°s seguro de que quieres vaciar todo el carrito?")) {
        carrito = [];
        actualizarTotales();
        cerrarModalPago();
        renderizarProductos();
        alert("üóëÔ∏è Carrito vaciado");
    }
};

        async function inicializarStripe(total) {
            try {
                const response = await fetch('/crear-sesion-pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: Math.round(total * 100) })
                });
                
                if (!response.ok) throw new Error('Error creando sesi√≥n de pago');
                const { clientSecret } = await response.json();

                elements = stripe.elements({ clientSecret });
                paymentElement = elements.create('payment', { layout: 'tabs' });
                paymentElement.mount('#payment-element');
            } catch (error) {
                console.error('Error inicializando Stripe:', error);
                document.getElementById('payment-element').innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg text-sm text-yellow-800">
                        <p>‚ö†Ô∏è Pago online no disponible</p>
                        <p class="mt-1">Usa la opci√≥n "Pagar en Barra"</p>
                    </div>
                `;
            }
        }

        window.abrirModalPago = async () => {
            if(carrito.length === 0) {
                alert("üõí El carrito est√° vac√≠o");
                return;
            }
            
            const mesa = document.getElementById('mesa-input').value;
            if(!mesa) {
                alert("ü™ë Por favor, indica el n√∫mero de mesa");
                document.getElementById('mesa-input').focus();
                return;
            }

            const lista = document.getElementById('lista-resumen');
            lista.innerHTML = '';
            carrito.forEach(i => {
                lista.innerHTML += `<li class="flex justify-between py-1 border-b border-gray-200 last:border-0"><span>${i.cantidad}x ${i.nombre}</span></li>`;
            });
            
const total = carrito.reduce((sum, item) => 
    sum + (parseFloat(item.precio) * item.cantidad), 0);

const base = total / 1.10;
const iva = total - base;

document.getElementById('modal-total-pago').innerHTML = `
    <div class="text-sm text-gray-600 flex justify-between">
        <span>Base imponible:</span>
        <span>${base.toFixed(2)}‚Ç¨</span>
    </div>
    <div class="text-sm text-gray-600 flex justify-between">
        <span>IVA incluido (10%):</span>
        <span>${iva.toFixed(2)}‚Ç¨</span>
    </div>
    <div class="flex justify-between font-bold text-lg text-indigo-600 mt-2 border-t pt-2">
        <span>Total:</span>
        <span>${total.toFixed(2)}‚Ç¨</span>
    </div>
`;
            document.getElementById('modal-pago').classList.remove('hidden');

            await inicializarStripe(total);
        };

        window.cerrarModalPago = () => {
            document.getElementById('modal-pago').classList.add('hidden');
        };

        // ============================================
        // üí≥ PAGO CON TARJETA
        // ============================================

        window.procesarPago = async () => {
            const submitButton = document.getElementById('submit-button');
            const messageDiv = document.getElementById('payment-message');
            
            submitButton.disabled = true;
            submitButton.innerText = '‚è≥ Procesando...';
            messageDiv.classList.add('hidden');

            const mesa = document.getElementById('mesa-input').value;
            const total = carrito.reduce((sum, item) => sum + (parseFloat(item.precio) * item.cantidad), 0);

            try {
                const { error } = await stripe.confirmPayment({
                    elements,
                    confirmParams: { return_url: window.location.href.split('?')[0] + '?pago=exitoso' }
                });

                if (error) throw new Error(error.message);

                const docRef = await addDoc(collection(db, "pedidos"), {
                    mesa: mesa,
                    productos: carrito,
                    estado: "pendiente",
                    fecha: serverTimestamp(),
                    pago: { estado: "completado", metodo: "tarjeta", total: total }
                });

                generarTicket({ mesa, productos: carrito, pago: { metodo: "tarjeta" } }, docRef.id);
                carrito = [];
                actualizarTotales();
                cerrarModalPago();

            } catch (error) {
                console.error('Error en pago:', error);
                messageDiv.innerText = '‚ùå ' + error.message;
                messageDiv.classList.remove('hidden');
                submitButton.disabled = false;
                submitButton.innerText = 'üí≥ Pagar con Tarjeta Ahora';
            }
        };

        // ============================================
        // üç∫ PEDIR Y PAGAR EN BARRA
        // ============================================

window.pedirPagarEnBarra = async () => {
    const mesa = document.getElementById('mesa-input').value;

    if (!mesa) {
        alert("ü™ë Indica el n√∫mero de mesa");
        return;
    }

    if (carrito.length === 0) {
        alert("üõí Carrito vac√≠o");
        return;
    }

    // üîπ TOTAL (ya incluye IVA)
    const total = carrito.reduce((sum, item) =>
        sum + (parseFloat(item.precio) * item.cantidad), 0);

    // üîπ Desglose IVA incluido
    const base = total / 1.10;
    const iva = total - base;

    const confirmar = confirm(
        `üìã Resumen del pedido:\n\n` +
        `ü™ë Mesa: ${mesa}\n` +
        `üç∫ Productos: ${carrito.length}\n\n` +
        `Base imponible: ${base.toFixed(2)}‚Ç¨\n` +
        `IVA incluido (10%): ${iva.toFixed(2)}‚Ç¨\n` +
        `TOTAL: ${total.toFixed(2)}‚Ç¨\n\n` +
        `¬øConfirmar pedido para pagar en barra?`
    );

    if (!confirmar) return;

    try {
        const docRef = await addDoc(collection(db, "pedidos"), {
            mesa: mesa,
            productos: carrito,
            estado: "pendiente",
            fecha: serverTimestamp(),
            pago: {
                estado: "pendiente",
                metodo: "en_barra",
                base: base,
                iva: iva,
                total: total
            }
        });

        generarTicket({
            mesa,
            productos: carrito,
            pago: { metodo: "en_barra" }
        }, docRef.id);

        carrito = [];
        actualizarTotales();
        cerrarModalPago();

    } catch (e) {
        console.error("Error:", e);
        alert("‚ùå Error al enviar el pedido");
    }
};

        // ============================================
        // üßæ GENERADOR DE TICKETS
        // ============================================

        function generarTicket(pedido, idPedido) {
            pedidoActualData = { ...pedido, id: idPedido };
            
            document.getElementById('ticket-logo').src = CONFIG_BAR.logo;
            document.getElementById('ticket-nombre-bar').innerText = CONFIG_BAR.nombre;
            document.getElementById('ticket-direccion').innerText = CONFIG_BAR.direccion;
            document.getElementById('ticket-telefono').innerText = "Tel: " + CONFIG_BAR.telefonoBar;
            document.getElementById('ticket-cif').innerText = "CIF: " + CONFIG_BAR.cif;
            
            const ticketId = Math.random().toString(36).substr(2, 6).toUpperCase();
            document.getElementById('ticket-id').innerText = ticketId;
            
            const ahora = new Date();
            document.getElementById('ticket-fecha').innerText = ahora.toLocaleDateString('es-ES') + ' ' + ahora.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('ticket-mesa').innerText = pedido.mesa;
            
            const metodo = pedido.pago?.metodo || 'efectivo';
            if (metodo === 'tarjeta') {
                document.getElementById('ticket-metodo-pago').innerText = 'üí≥ Tarjeta (Online)';
                document.getElementById('mensaje-pago-barra').innerText = '‚úÖ Pago realizado con tarjeta';
                document.getElementById('mensaje-pago-barra').className = 'mt-2 text-green-600 font-bold';
            } else if (metodo === 'en_barra') {
                document.getElementById('ticket-metodo-pago').innerText = 'üíµ Pagar en Barra';
                document.getElementById('mensaje-pago-barra').innerText = 'üíµ Paga en la barra al finalizar';
                document.getElementById('mensaje-pago-barra').className = 'mt-2 text-orange-600 font-bold';
            } else {
                document.getElementById('ticket-metodo-pago').innerText = 'üíµ Efectivo';
                document.getElementById('mensaje-pago-barra').innerText = 'üíµ Paga en la barra al finalizar';
                document.getElementById('mensaje-pago-barra').className = 'mt-2 text-orange-600 font-bold';
            }
            
            const tbody = document.getElementById('ticket-productos');
            tbody.innerHTML = '';
            
            carrito.forEach(item => {
                tbody.innerHTML += `<tr class="border-b border-gray-200 last:border-0"><td class="py-3">${item.cantidad}x</td><td class="py-3">${item.nombre}</td><td class="py-3 text-right">${(item.cantidad * item.precio).toFixed(2)}‚Ç¨</td></tr>`;
            });
            
const total = carrito.reduce((sum, p) => 
    sum + (parseFloat(p.precio) * p.cantidad), 0);

const base = total / 1.10;
const iva = total - base;

document.getElementById('ticket-subtotal').innerText = base.toFixed(2) + '‚Ç¨';
document.getElementById('ticket-iva').innerText = iva.toFixed(2) + '‚Ç¨';
document.getElementById('ticket-total').innerText = total.toFixed(2) + '‚Ç¨';
            
            pedidoActualId = idPedido;
            document.getElementById('vista-ticket').classList.remove('hidden');
        }

        window.imprimirTicket = () => { window.print(); };

        window.enviarWhatsApp = () => {
            if (!pedidoActualData) { alert("No hay datos del pedido"); return; }
            
            const ticketId = document.getElementById('ticket-id').innerText;
            const fecha = document.getElementById('ticket-fecha').innerText;
            const mesa = document.getElementById('ticket-mesa').innerText;
            const total = document.getElementById('ticket-total').innerText;
            
            let productosTexto = '';
            carrito.forEach(i => { productosTexto += `‚Ä¢ ${i.cantidad}x ${i.nombre}%0A`; });
            
            const metodoPago = pedidoActualData.pago?.metodo === 'tarjeta' ? 'üí≥ Tarjeta (Pagado)' : 'üíµ Pagar en Barra';
            
            const mensaje = `*${CONFIG_BAR.nombre}* üç∫%0A%0A*Ticket #${ticketId}*%0AüìÖ ${fecha}%0Aü™ë Mesa: ${mesa}%0Aüí≥ Pago: ${metodoPago}%0A%0A*Pedido:*%0A${productosTexto}%0A*TOTAL: ${total}*%0A%0A¬°Gracias por tu visita! üôè`;
            
            window.open(`https://wa.me/${CONFIG_BAR.telefono}?text=${mensaje}`, '_blank');
        };

        window.cerrarTicket = () => {
            document.getElementById('vista-ticket').classList.add('hidden');
            pedidoActualData = null;
        };

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('SW registrado')).catch(err => console.error('Error SW:', err));
        }
    </script>
</body>
</html>